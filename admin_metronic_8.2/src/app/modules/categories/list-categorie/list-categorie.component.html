<div class="card">
    <div class="card-header border-0 pt-6">
        <div class="card-title">
            <!--begin::Search-->
            <div class="d-flex align-items-center position-relative my-1">
                <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>

                <input type="text" (ngModelChange)="searchTo()" [(ngModel)]="search"
                    class="form-control form-control-solid w-250px ps-12" placeholder="Buscar Categoría">

                <!-- Loader a la derecha -->
                <i *ngIf="isLoading$ | async"
                    class="spinner-border spinner-border-sm text-primary position-absolute end-0 me-3"></i>
            </div>
            <!--end::Search-->
        </div>

        <div class="card-toolbar">
            <!--begin::Add customer-->
            <a routerLink="/categories/register" class="btn btn-primary">
                Añadir Categoria
            </a>
            <!--end::Add customer-->
        </div>
    </div>


    <div class="card-body py-4">
        <div class="table-responsive">
            <table class="table align-middle table-row-dashed fs-6 gy-5">
                <thead>
                    <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                        <th>Nombre</th>
                        <th>Icono</th>
                        <th>Estado</th>
                        <th>Departamento</th>
                        <th>Categoría</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 fw-semibold">

                    <!-- Nivel Abuelo -->
                    <ng-container *ngFor="let grandpa of categories">
                        <tr>
                            <!-- Nombre con imagen -->
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="symbol symbol-50px me-3" *ngIf="grandpa.image">
                                        <span class="symbol-label"
                                            [ngStyle]="{'background-image': 'url(' + grandpa.image + ')'}"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-900 fw-bold mb-1 fs-6">{{ grandpa.name }}</span>
                                    </div>
                                </div>
                            </td>

                            <!-- Icono -->
                            <td>
                                <ng-container *ngIf="grandpa.icon; else noIconGrandpa">
                                    <div class="symbol symbol-50px me-3">
                                        <span class="symbol-label"
                                            [ngStyle]="{'background-image': 'url(' + grandpa.icon + ')', 'background-size': 'contain', 'background-repeat': 'no-repeat', 'background-position': 'center'}">
                                        </span>
                                    </div>
                                </ng-container>
                                <ng-template #noIconGrandpa>N/A</ng-template>
                            </td>

                            <!-- Estado -->
                            <td>
                                <span class="badge fs-7 fw-bold"
                                    [ngClass]="{'badge-light-primary': grandpa.status==1, 'badge-light-danger': grandpa.status==2}">
                                    {{ grandpa.status == 1 ? 'Activo' : 'Inactivo' }}
                                </span>
                            </td>

                            <td>-</td>
                            <td>-</td>
                            <td class="text-end">

                                <a [routerLink]="'/categories/list/edit/'+grandpa.id"
                                    class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                                    <i class="ki-duotone ki-pencil fs-2"><span class="path1"></span><span
                                            class="path2"></span></i> </a>

                                <a href="#" onclick="return false" (click)="deleteCategorie(grandpa)"
                                    class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm">
                                    <i class="ki-duotone ki-trash fs-2"><span class="path1"></span><span
                                            class="path2"></span><span class="path3"></span><span
                                            class="path4"></span><span class="path5"></span></i> </a>
                            </td>
                        </tr>

                        <!-- Nivel Padre -->
                        <ng-container *ngFor="let parent of grandpa.children">
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="symbol symbol-50px me-3" *ngIf="parent.image">
                                            <span class="symbol-label"
                                                [ngStyle]="{'background-image': 'url(' + parent.image + ')'}"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-900 fw-bold mb-1 fs-6">{{ parent.name }}</span>
                                        </div>
                                    </div>
                                </td>

                                <td>
                                    <ng-container *ngIf="parent.icon; else noIconParent">
                                        <div class="symbol symbol-50px me-3">
                                            <span class="symbol-label"
                                                [ngStyle]="{'background-image': 'url(' + parent.icon + ')', 'background-size': 'contain', 'background-repeat': 'no-repeat', 'background-position': 'center'}">
                                            </span>
                                        </div>
                                    </ng-container>
                                    <ng-template #noIconParent>N/A</ng-template>
                                </td>

                                <td>
                                    <span class="badge fs-7 fw-bold"
                                        [ngClass]="{'badge-light-primary': parent.status==1, 'badge-light-danger': parent.status==2}">
                                        {{ parent.status == 1 ? 'Activo' : 'Inactivo' }}
                                    </span>
                                </td>

                                <td>{{ parent.categorie_second?.name || '-' }}</td>
                                <td>-</td>
                                <td class="text-end">

                                    <a [routerLink]="'/categories/list/edit/'+parent.id"
                                        class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                                        <i class="ki-duotone ki-pencil fs-2"><span class="path1"></span><span
                                                class="path2"></span></i> </a>

                                    <a href="#" onclick="return false" (click)="deleteCategorie(parent)"
                                        class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm">
                                        <i class="ki-duotone ki-trash fs-2"><span class="path1"></span><span
                                                class="path2"></span><span class="path3"></span><span
                                                class="path4"></span><span class="path5"></span></i> </a>
                                </td>
                            </tr>

                            <!-- Nivel Hijo -->
                            <ng-container *ngFor="let child of parent.children">
                                <tr>
                                    <td class="ps-10">
                                        <div class="d-flex align-items-center">
                                            <div class="symbol symbol-50px me-3" *ngIf="child.image">
                                                <span class="symbol-label"
                                                    [ngStyle]="{'background-image': 'url(' + child.image + ')'}"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-900 fw-bold mb-1 fs-6">{{ child.name }}</span>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <ng-container *ngIf="child.icon; else noIconChild">
                                            <div class="symbol symbol-50px me-3">
                                                <span class="symbol-label"
                                                    [ngStyle]="{'background-image': 'url(' + child.icon + ')', 'background-size': 'contain', 'background-repeat': 'no-repeat', 'background-position': 'center'}">
                                                </span>
                                            </div>
                                        </ng-container>
                                        <ng-template #noIconChild>N/A</ng-template>
                                    </td>

                                    <td>
                                        <span class="badge fs-7 fw-bold"
                                            [ngClass]="{'badge-light-primary': child.status==1, 'badge-light-danger': child.status==2}">
                                            {{ child.status == 1 ? 'Activo' : 'Inactivo' }}
                                        </span>
                                    </td>

                                    <td>{{ child.categorie_second?.name || '-' }}</td>
                                    <td>{{ child.categorie_third?.name || '-' }}</td>
                                    <td class="text-end">

                                        <a [routerLink]="'/categories/list/edit/'+child.id"
                                            class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                                            <i class="ki-duotone ki-pencil fs-2"><span class="path1"></span><span
                                                    class="path2"></span></i> </a>

                                        <a href="#" onclick="return false" (click)="deleteCategorie(child)"
                                            class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm">
                                            <i class="ki-duotone ki-trash fs-2"><span class="path1"></span><span
                                                    class="path2"></span><span class="path3"></span><span
                                                    class="path4"></span><span class="path5"></span></i> </a>
                                    </td>
                                </tr>
                            </ng-container>

                        </ng-container>
                    </ng-container>

                    <tr *ngIf="categories.length === 0">
                        <td colspan="6" class="text-center text-muted py-4">No se encontraron categorías</td>
                    </tr>

                </tbody>
            </table>

            <ngb-pagination [collectionSize]="totalPages" [(page)]="currentPage" [pageSize]="15" [rotate]="true"
                [boundaryLinks]="true" (pageChange)="loadPage($event)">
            </ngb-pagination>
        </div>
    </div>
</div>